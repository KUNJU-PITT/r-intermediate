---
title: "Summarising, Grouping and Joining Exercise"
date: '`r format(Sys.time(), "Last modified: %d %b %Y")`'
output: html_document
---

### Summarising

The first part of the exercise uses the patients dataset we've been using in previous sections of the course. After reading this into R, answer the following questions using the `summarise`, `summarise_each` and `mutate_each` functions.

```{r message=FALSE}
library(dplyr)
patients <- read.delim("patient-data-cleaned.txt", stringsAsFactors = FALSE) %>% tbl_df
patients %>% head(5)
```

******

Compute the mean age, height and weight of patients in the patients dataset

- Modify the output by adding a step to round to 2 decimal places

******

```{r}
patients %>%
  summarize_each(funs(mean), Age, Height, Weight) %>%
  mutate_each(funs(round(., digits = 2)))
```

******

See what happens if you try to compute the mean of a logical (boolean) variable

- What proportion of our patient cohort has died?

******

```{r}
patients %>% summarize(mean(Died))
```

******

### Grouping

The following questions require grouping of patients based on one or more attributes using the `group_by` function.

Compare the average height of males and females in this patient cohort.

Are smokers heavier or lighter on average than non-smokers in this dataset?

******

```{r}
patients %>%
  group_by(Sex) %>%
  summarize(`Average height` = mean(Height))

patients %>%
  group_by(Smokes) %>%
  summarize(`Average weight` = mean(Weight))

patients %>%
  group_by(Sex, Smokes) %>%
  summarize(`Average weight` = mean(Weight))
```

******

### Joining

The patients are all part of a diabetes study and have had their blood glucose concentration and diastolic blood pressure measured on several dates.

This part of the exercise combines grouping, summarisation and joining operations to connect the diabetes study data to the patients table we've already been working with.

```{r}
diabetes <- read.delim("diabetes.txt", stringsAsFactors = FALSE) %>% tbl_df
diabetes %>% head(5)
```

******

Join the blood pressure and glucose measurements and the dates they were taken to the patient data using the ID column.

- How many rows are there in the resultant data frame? Compare this with the sizes of the patients and diabetes data frames. Why are these different?

******

```{r}
combined <- left_join(diabetes, patients, by = "ID")
combined

nrow(combined)

dim(combined)
dim(patients)
dim(diabetes)
```

******

Create a new data frame that only includes the most recent blood pressure and glucose measurement for each patient and then join this to the patients data frame.

*[hint: use `group_by` to work on groups of observations for each patient separately, sort by date using `arrange` and then select the last row using `summarize_each` with the function `last`]*

- Again compare the size of the resultant data frame with the patients and diabetes data 
frames.

******

```{r}
last_visit <- diabetes %>%
  group_by(ID) %>%
  arrange(Date) %>%
  summarize_each(funs(last)) %>%
  rename(`Last Visit` = Date)
last_visit

combined <- left_join(last_visit, patients, by = "ID")
combined
```

******
